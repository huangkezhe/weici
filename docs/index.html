<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MD Dictionary Pro</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“˜</text></svg>" />
<style>
  :root {
    --bg-body: #f8f9fa; --bg-panel: #ffffff; --text-main: #2c3e50; --text-muted: #8590a6;
    --border: #e1e4e8; --accent: #007bff; --accent-hover: #0056b3; --accent-light: rgba(0, 123, 255, 0.1);
    --hover: #f1f3f5; --modal-mask: rgba(0,0,0,0.5);
    --md-quote-bg: #f8f9fa; --md-code-bg: rgba(27,31,35,0.05);
  }
  body.dark-mode {
    --bg-body: #0d1117; --bg-panel: #161b22; --text-main: #c9d1d9; --text-muted: #8b949e;
    --border: #30363d; --accent: #58a6ff; --accent-hover: #79c0ff; --accent-light: rgba(56, 139, 253, 0.15);
    --modal-mask: rgba(0,0,0,0.8); --md-quote-bg: #21262d; --md-code-bg: rgba(240,246,252,0.15);
  }

  * { box-sizing: border-box; }
  body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; transition: 0.3s; }
  button { border: none; outline: none; cursor: pointer; font-family: inherit; background: transparent; color: inherit; }

  /* --- é¡µé¢åˆ‡æ¢ --- */
  .page { display: none; width: 100%; height: 100%; position: absolute; top:0; left:0; }
  .page.active { display: flex; z-index: 10; } /* å¢åŠ  z-index ç¡®ä¿ active åœ¨æœ€ä¸Šå±‚ */

  /* ================== é¦–é¡µ ================== */
  #page-home { flex-direction: column; align-items: center; justify-content: center; }
  .hero-box { text-align: center; animation: fadeUp 0.5s; }
  @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  
  .search-hero {
    width: 600px; max-width: 90%; position: relative; margin: 30px 0;
  }
  .search-hero input {
    width: 100%; padding: 20px 24px; font-size: 18px; border-radius: 16px;
    border: 1px solid var(--border); background: var(--bg-panel); color: var(--text-main);
    box-shadow: 0 10px 30px rgba(0,0,0,0.05); outline: none; transition: 0.2s;
  }
  .search-hero input:focus { border-color: var(--accent); box-shadow: 0 0 0 4px var(--accent-light); }
  
  .btn-main { padding: 12px 30px; background: var(--accent); color: white; border-radius: 8px; font-weight: 600; font-size: 16px; transition: 0.2s; }
  .btn-main:hover { background: var(--accent-hover); transform: translateY(-2px); }

  /* ================== åº”ç”¨é¡µ (å·¦ä¾§åˆ—è¡¨+å³ä¾§å†…å®¹) ================== */
  /* ä¿®å¤ç‚¹1ï¼šå»æ‰è¿™é‡ŒåŸæ¥çš„ display: flexï¼Œé˜²æ­¢å¼ºåˆ¶æ˜¾ç¤º */
  #page-app { }
  
  .sidebar { width: 320px; background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 2; }
  .sidebar-header { padding: 14px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: center; }
  .icon-btn { padding: 8px; border-radius: 6px; color: var(--text-muted); font-size: 18px; }
  .icon-btn:hover { background: var(--hover); color: var(--accent); }
  
  .mini-search { flex: 1; padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-main); }
  
  .list-container { flex: 1; overflow-y: auto; }
  .list-item { padding: 12px 16px; border-bottom: 1px solid var(--border); cursor: pointer; }
  .list-item:hover { background: var(--hover); }
  .list-item.active { background: var(--accent-light); border-left: 4px solid var(--accent); }
  .item-title { font-weight: 600; margin-bottom: 4px; }
  .item-meta { font-size: 12px; color: var(--text-muted); display: flex; justify-content: space-between; }

  .content-area { flex: 1; background: var(--bg-body); display: flex; flex-direction: column; position: relative; }
  .content-header { height: 50px; border-bottom: 1px solid var(--border); background: var(--bg-panel); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
  .md-scroll { flex: 1; overflow-y: auto; padding: 40px; }
  .markdown-body { max-width: 800px; margin: 0 auto; line-height: 1.8; font-size: 16px; padding-bottom: 100px; }

  /* MD æ ·å¼ */
  .markdown-body h1 { border-bottom: 1px solid var(--border); padding-bottom: 10px; font-size: 28px; }
  .markdown-body h2 { margin-top: 40px; color: var(--accent); border-left: 4px solid var(--accent); padding-left: 12px; font-size: 22px; background: linear-gradient(90deg, var(--accent-light), transparent); padding-top:4px; padding-bottom:4px; border-radius:0 4px 4px 0; }
  .markdown-body blockquote { border-left: 4px solid var(--border); padding: 10px 20px; color: var(--text-muted); background: var(--md-quote-bg); margin: 20px 0; border-radius: 4px; }
  .markdown-body table { width: 100%; border-collapse: collapse; margin: 20px 0; }
  .markdown-body th, .markdown-body td { border: 1px solid var(--border); padding: 8px 12px; }
  .markdown-body th { background: var(--bg-panel); }
  .markdown-body audio { width: 100%; height: 40px; margin: 10px 0; border-radius: 20px; }
  /* ä¿®å¤å†…éƒ¨é“¾æ¥æ ·å¼ */
  .markdown-body a { color: var(--accent); text-decoration: none; border-bottom: 1px dashed var(--accent); cursor: pointer; }
  .markdown-body ul, .markdown-body ol { padding-left: 20px; }
  .markdown-body li { margin-bottom: 8px; }

  /* å…¨å±€åŠ è½½é®ç½© (é˜²æ­¢æœªå“åº”) */
  #global-loader {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: var(--modal-mask); backdrop-filter: blur(5px);
    z-index: 9999; display: none; flex-direction: column;
    align-items: center; justify-content: center; color: white;
  }
  .spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.3); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  
  /* æ‹–æ‹½æç¤ºå±‚ */
  #drag-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: var(--accent-light); border: 4px dashed var(--accent);
    z-index: 5000; display: none; align-items: center; justify-content: center;
    font-size: 24px; color: var(--accent); font-weight: bold; pointer-events: none;
  }

  /* å¼¹çª— */
  .modal-overlay { position: fixed; inset: 0; background: var(--modal-mask); z-index: 1000; display: none; align-items: center; justify-content: center; }
  .modal { background: var(--bg-panel); width: 320px; border-radius: 12px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
  .modal h3 { margin-top: 0; }
  .setting-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }

</style>
</head>
<body>

<!-- å…¨å±€åŠ è½½åŠ¨ç”» -->
<div id="global-loader">
  <div class="spinner"></div>
  <div id="loader-text" style="font-size: 16px;">æ­£åœ¨å‡†å¤‡...</div>
  <div id="loader-sub" style="font-size: 12px; margin-top: 8px; opacity: 0.8;"></div>
</div>

<!-- æ‹–æ‹½æç¤º -->
<div id="drag-overlay">æ¾å¼€é¼ æ ‡ä»¥åŠ è½½è¯å…¸æ–‡ä»¶å¤¹</div>

<!-- 1. é¦–é¡µ -->
<div id="page-home" class="page active">
  <div class="hero-box">
    <div style="font-size: 80px; margin-bottom: 20px;">ğŸ“˜</div>
    <h1 style="margin: 0;">MD Dictionary Pro</h1>
    <p style="color: var(--text-muted);">æœ¬åœ° Â· æé€Ÿ Â· æ²‰æµ¸å¼</p>
    
    <div class="search-hero">
      <input type="text" id="homeSearch" placeholder="è¾“å…¥å•è¯..." disabled>
    </div>
    
    <div style="display: flex; gap: 15px; justify-content: center;">
      <button class="btn-main" id="btnPick">é€‰æ‹©æ–‡ä»¶å¤¹</button>
      <button class="icon-btn" id="btnSettingsHome" style="border:1px solid var(--border)">âš™ï¸</button>
    </div>
    
    <p id="status-text" style="font-size: 13px; color: var(--text-muted); margin-top: 20px;">
      æ”¯æŒä»»æ„ç•Œé¢æ‹–å…¥æ–‡ä»¶å¤¹ (å« 3/ å’Œ media/)
    </p>
  </div>
</div>

<!-- 2. åº”ç”¨é¡µ -->
<div id="page-app" class="page">
  <div class="sidebar">
    <div class="sidebar-header">
      <button class="icon-btn" id="btnHome" title="è¿”å›é¦–é¡µ">ğŸ </button>
      <input type="search" id="appSearch" class="mini-search" placeholder="æœç´¢...">
    </div>
    <div class="list-container" id="wordList"></div>
  </div>
  <div class="content-area">
    <div class="content-header">
      <strong id="docTitle">è¯¦ç»†é‡Šä¹‰</strong>
      <button class="icon-btn" id="btnSettingsApp">âš™ï¸</button>
    </div>
    <div class="md-scroll">
      <div class="markdown-body" id="mdContent">
        <div style="text-align: center; color: var(--text-muted); margin-top: 50px;">
          è¯·åœ¨å·¦ä¾§é€‰æ‹©å•è¯
        </div>
      </div>
    </div>
  </div>
</div>

<!-- è®¾ç½®å¼¹çª— -->
<div class="modal-overlay" id="modalSettings">
  <div class="modal">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h3>è®¾ç½®</h3>
      <button id="btnCloseSettings" style="font-size:20px;">Ã—</button>
    </div>
    <div class="setting-item">
      <span>æ·±è‰²æ¨¡å¼</span>
      <button class="icon-btn" id="btnTheme">ğŸŒ— åˆ‡æ¢</button>
    </div>
    <div class="setting-item">
      <span>æ¸…ç©ºç¼“å­˜</span>
      <button class="icon-btn" id="btnClear" style="color:#ff4d4f;">ğŸ—‘ æ¸…ç©º</button>
    </div>
    <div style="font-size:12px; color:var(--text-muted); background:var(--bg-body); padding:10px; border-radius:6px; line-height:1.5;">
      æ³¨æ„ï¼šæ–‡æœ¬ç´¢å¼•ä¼šä¿å­˜åœ¨æµè§ˆå™¨ä¸­ï¼Œä½†<b>éŸ³é¢‘æ–‡ä»¶</b>å—æµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œåˆ·æ–°é¡µé¢åå¿…é¡»<b>é‡æ–°æ‹–å…¥æ–‡ä»¶å¤¹</b>æ‰èƒ½æ’­æ”¾ã€‚
    </div>
  </div>
</div>

<input type="file" id="fileInput" webkitdirectory directory multiple style="display:none">

<script>
// --- å…¨å±€çŠ¶æ€ ---
const state = {
  db: null,
  mediaMap: new Map(), // filename -> Blob
  index: [],           // { key, path, type }
  isReady: false
};

// --- DOM ---
const UI = {
  loader: document.getElementById('global-loader'),
  loaderText: document.getElementById('loader-text'),
  loaderSub: document.getElementById('loader-sub'),
  dragOverlay: document.getElementById('drag-overlay'),
  homePage: document.getElementById('page-home'),
  appPage: document.getElementById('page-app'),
  homeSearch: document.getElementById('homeSearch'),
  appSearch: document.getElementById('appSearch'),
  wordList: document.getElementById('wordList'),
  mdContent: document.getElementById('mdContent'),
  docTitle: document.getElementById('docTitle')
};

// --- åˆå§‹åŒ–é¡ºåºè°ƒæ•´ï¼šå…ˆç»‘äº‹ä»¶ï¼Œå†åŠ è½½ DB ---
setupEvents();

(async () => {
  try {
    await initDB();
    await loadIndexFromDB();
  } catch(e) {
    console.warn("DB Load Warning:", e);
  }
})();

// --- IndexedDB ---
function initDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open('MD_DICT_V2', 1);
    req.onupgradeneeded = e => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains('files')) db.createObjectStore('files', { keyPath: 'path' });
    };
    req.onsuccess = e => { state.db = e.target.result; resolve(); };
    req.onerror = reject;
  });
}

async function loadIndexFromDB() {
  const keys = await new Promise(resolve => {
    const tx = state.db.transaction('files', 'readonly');
    tx.objectStore('files').getAllKeys().onsuccess = e => resolve(e.target.result);
  });
  
  if (keys.length > 0) {
    state.index = keys
      .filter(path => {
        const name = path.split('/').pop().toLowerCase();
        return name !== '_sidebar.md' && name !== 'readme.md';
      })
      .map(path => ({
        key: path.split('/').pop().replace('.md', ''),
        path: path,
        type: path.includes('_word_group') ? 'group' : (path.includes('_special_word') ? 'special' : 'word')
      }));
      
    state.isReady = true;
    UI.homeSearch.disabled = false;
    UI.homeSearch.placeholder = `å·²åŠ è½½ ${state.index.length} ä¸ªè¯æ¡ï¼Œè¾“å…¥æœç´¢...`;
    
    if(state.index.length > 0) doSearch('');
  } else {
    UI.homeSearch.placeholder = "è¯·å…ˆåŠ è½½è¯å…¸ç›®å½•...";
  }
}

async function saveFilesToDB(files) {
  return new Promise((resolve, reject) => {
    const tx = state.db.transaction('files', 'readwrite');
    const store = tx.objectStore('files');
    files.forEach(f => store.put(f));
    tx.oncomplete = resolve;
    tx.onerror = reject;
  });
}

// --- äº‹ä»¶å¤„ç† ---
function setupEvents() {
  // æ–‡ä»¶é€‰æ‹©
  document.getElementById('btnPick').onclick = () => document.getElementById('fileInput').click();
  document.getElementById('fileInput').onchange = e => handleFiles(e.target.files);

  // æœç´¢
  UI.homeSearch.onkeydown = e => {
    if (e.key === 'Enter' && state.isReady) {
      goToApp(UI.homeSearch.value);
    }
  };
  let timer;
  UI.appSearch.oninput = e => {
    clearTimeout(timer);
    timer = setTimeout(() => doSearch(e.target.value), 200);
  };

  // å¯¼èˆª
  document.getElementById('btnHome').onclick = () => {
    UI.appPage.classList.remove('active');
    UI.homePage.classList.add('active');
    UI.homeSearch.value = '';
    UI.homeSearch.focus();
  };
  
  // å¤„ç† Markdown å†…éƒ¨é“¾æ¥ç‚¹å‡»
  UI.mdContent.addEventListener('click', e => {
    if (e.target.classList.contains('internal-link')) {
      const targetKey = e.target.dataset.target;
      UI.appSearch.value = targetKey;
      doSearch(targetKey);
    }
  });

  // æ‹–æ‹½ (å…¨å±€)
  document.addEventListener('dragover', e => { e.preventDefault(); UI.dragOverlay.style.display = 'flex'; });
  document.addEventListener('dragleave', e => { 
    if (e.clientX === 0 && e.clientY === 0) UI.dragOverlay.style.display = 'none'; 
  });
  document.addEventListener('drop', async e => {
    e.preventDefault();
    UI.dragOverlay.style.display = 'none';
    const items = e.dataTransfer.items;
    if (items) {
      UI.loader.style.display = 'flex';
      UI.loaderText.textContent = "æ­£åœ¨æ‰«ææ–‡ä»¶...";
      setTimeout(async () => {
        const files = await scanFilesSafe(items);
        handleFiles(files);
      }, 50);
    }
  });

  // è®¾ç½®
  const toggleSettings = (show) => document.getElementById('modalSettings').style.display = show ? 'flex' : 'none';
  document.getElementById('btnSettingsHome').onclick = () => toggleSettings(true);
  document.getElementById('btnSettingsApp').onclick = () => toggleSettings(true);
  document.getElementById('btnCloseSettings').onclick = () => toggleSettings(false);
  document.getElementById('btnClear').onclick = async () => {
    if(state.db) {
        const tx = state.db.transaction('files', 'readwrite');
        tx.objectStore('files').clear();
    }
    location.reload();
  };
  document.getElementById('btnTheme').onclick = () => document.body.classList.toggle('dark-mode');
}

// --- æ–‡ä»¶æ‰«æ ---
async function scanFilesSafe(items) {
  const files = [];
  let processedCount = 0;

  async function traverse(entry) {
    if (!entry) return;
    processedCount++;
    if (processedCount % 50 === 0) {
      UI.loaderSub.textContent = `å·²æ‰«æ ${processedCount} ä¸ªé¡¹ç›®...`;
      await new Promise(r => setTimeout(r, 0));
    }

    if (entry.isFile) {
      await new Promise(resolve => {
        entry.file(f => {
          Object.defineProperty(f, 'webkitRelativePath', { value: entry.fullPath.substring(1) });
          files.push(f);
          resolve();
        });
      });
    } else if (entry.isDirectory) {
      const reader = entry.createReader();
      const entries = await new Promise(resolve => {
        let all = [];
        function read() {
          reader.readEntries(batch => {
            if (batch.length > 0) { all = all.concat(batch); read(); }
            else resolve(all);
          });
        }
        read();
      });
      for (const e of entries) await traverse(e);
    }
  }

  for (let i = 0; i < items.length; i++) {
    await traverse(items[i].webkitGetAsEntry());
  }
  return files;
}

// --- æ–‡ä»¶å¤„ç† ---
async function handleFiles(fileList) {
  if (!fileList || fileList.length === 0) {
    UI.loader.style.display = 'none';
    return;
  }

  UI.loaderText.textContent = "æ­£åœ¨åˆ†ææ•°æ®...";
  
  const textFiles = [];
  let mdCount = 0;
  let mediaCount = 0;

  state.mediaMap.clear();

  for (let i = 0; i < fileList.length; i++) {
    const f = fileList[i];
    
    if (i % 200 === 0) {
      UI.loaderSub.textContent = `è§£æä¸­ ${i}/${fileList.length}`;
      await new Promise(r => setTimeout(r, 0));
    }

    if (f.name.endsWith('.md')) {
      const lowerName = f.name.toLowerCase();
      if (lowerName === '_sidebar.md' || lowerName === 'readme.md') {
        continue;
      }
      textFiles.push(f); 
      mdCount++;
    } else if (/\.(aac|mp3|wav|m4a|ogg)$/i.test(f.name)) {
      state.mediaMap.set(f.name, f);
      mediaCount++;
    }
  }

  if (textFiles.length > 0) {
    UI.loaderText.textContent = "æ­£åœ¨å»ºç«‹ç´¢å¼•...";
    const dbData = [];
    for (let i = 0; i < textFiles.length; i++) {
      const f = textFiles[i];
      if (i % 100 === 0) {
        UI.loaderSub.textContent = `è¯»å–æ–‡æœ¬ ${i}/${textFiles.length}`;
        await new Promise(r => setTimeout(r, 0));
      }
      const text = await f.text();
      const path = f.webkitRelativePath || f.name;
      dbData.push({ path: path, content: text });
    }
    
    UI.loaderText.textContent = "æ­£åœ¨å†™å…¥æ•°æ®åº“...";
    await saveFilesToDB(dbData);
    await loadIndexFromDB();
  } else {
    alert("éŸ³é¢‘æ˜ å°„æ›´æ–°å®Œæˆï¼");
  }

  UI.loader.style.display = 'none';
  
  if (mdCount > 0) {
    const msg = `åŠ è½½å®Œæˆï¼š${mdCount} ä¸ªæ–‡æ¡£ï¼Œ${mediaCount} ä¸ªéŸ³é¢‘ã€‚`;
    alert(msg);
  }
  
  if (UI.appPage.classList.contains('active') && UI.docTitle.textContent !== 'è¯¦ç»†é‡Šä¹‰') {
    const currentKey = UI.docTitle.textContent;
    const item = state.index.find(i => i.key === currentKey);
    if(item) loadDoc(item);
  }
}

// --- ä¸šåŠ¡é€»è¾‘ ---
function goToApp(query) {
  UI.homePage.classList.remove('active');
  UI.appPage.classList.add('active');
  UI.appSearch.value = query;
  doSearch(query);
}

function doSearch(q) {
  q = q.toLowerCase().trim();
  UI.wordList.innerHTML = '';
  
  if (!state.index.length) return;

  const maxItems = 100;
  let count = 0;
  
  const matches = [];
  for (const item of state.index) {
    if (item.key.toLowerCase() === '_sidebar') continue;

    if (count >= maxItems) break;
    const k = item.key.toLowerCase();
    if (k.includes(q)) {
      let score = 0;
      if (k === q) score = 100;
      else if (k.startsWith(q)) score = 50;
      matches.push({ ...item, score });
    }
  }
  
  matches.sort((a,b) => b.score - a.score || a.key.localeCompare(b.key));
  
  if (matches.length === 0) {
    UI.wordList.innerHTML = '<div style="padding:20px;color:var(--text-muted)">æ— ç»“æœ</div>';
    return;
  }

  const fragment = document.createDocumentFragment();
  matches.slice(0, 100).forEach(item => {
    const div = document.createElement('div');
    div.className = 'list-item';
    div.innerHTML = `<div class="item-title">${item.key}</div><div class="item-meta">${item.type}</div>`;
    div.onclick = () => {
      document.querySelectorAll('.list-item').forEach(e => e.classList.remove('active'));
      div.classList.add('active');
      loadDoc(item);
    };
    fragment.appendChild(div);
  });
  UI.wordList.appendChild(fragment);
  
  if (q && matches.length > 0 && matches[0].score === 100) {
    UI.wordList.firstChild.classList.add('active');
    loadDoc(matches[0]);
  }
}

async function loadDoc(item) {
  UI.docTitle.textContent = item.key;
  UI.mdContent.innerHTML = '<div style="padding:40px;text-align:center">åŠ è½½ä¸­...</div>';
  
  const tx = state.db.transaction('files', 'readonly');
  const req = tx.objectStore('files').get(item.path);
  
  req.onsuccess = e => {
    const res = e.target.result;
    if (res) renderMarkdown(res.content);
    else UI.mdContent.innerHTML = 'æ–‡ä»¶è¯»å–å¤±è´¥';
  };
}

function renderMarkdown(text) {
  let out = text;
  const codes = [];
  
  // 1. ä¿æŠ¤ä»£ç å—
  out = out.replace(/```[\s\S]*?```/g, m => { codes.push(m); return `__CODE${codes.length-1}__`; });
  
  // 2. åŸºç¡€è½¬ä¹‰
  out = out.replace(/\\#/g, '#');
  
  // 3. éŸ³é¢‘
  out = out.replace(/<audio\s+[^>]*src=["']([^"']+)["'][^>]*>.*?<\/audio>/gi, (match, src) => {
    const filename = src.split('/').pop(); 
    if (state.mediaMap.has(filename)) {
      const url = URL.createObjectURL(state.mediaMap.get(filename));
      return `<audio controls src="${url}"></audio>`;
    } else {
      return `<div style="padding:10px;border:1px dashed #f56c6c;color:#f56c6c;border-radius:4px;font-size:12px;margin:10px 0;">
        âŒ éŸ³é¢‘æ–‡ä»¶æœªåŠ è½½: ${filename} <br> (è¯·å°† media æ–‡ä»¶å¤¹æ‹–å…¥é¡µé¢ä»¥æ¿€æ´»éŸ³é¢‘)
      </div>`;
    }
  });

  // 4. æ ‡é¢˜
  out = out.replace(/^### (.*$)/gm, '<h3>$1</h3>');
  out = out.replace(/^## (.*$)/gm, '<h2>$1</h2>');
  out = out.replace(/^# (.*$)/gm, '<h1>$1</h1>');
  
  // 5. å¼•ç”¨
  out = out.replace(/^>\s?(.*$)/gm, '<blockquote>$1</blockquote>');
  
  // 6. ç®€å•çš„åˆ—è¡¨æ”¯æŒ (ä¿®å¤ï¼šå¢åŠ åˆ—è¡¨æ˜¾ç¤º)
  out = out.replace(/^[\*\-]\s+(.*$)/gm, '<li>$1</li>');
  out = out.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>'); 

  // 7. ç²—ä½“ä¸å†…éƒ¨é“¾æ¥ (ä¿®å¤ï¼šå¢åŠ ç‚¹å‡»è·³è½¬)
  out = out.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  out = out.replace(/\[(.*?)\]\((.*?)\)/g, (match, text, link) => {
      const targetKey = link.split('/').pop().replace('.md', ''); 
      return `<a href="javascript:void(0)" class="internal-link" data-target="${targetKey}">${text}</a>`;
  });
  
  // 8. è¡¨æ ¼
  out = out.replace(/((?:^\|.*\|\r?\n)+)/gm, table => {
    const rows = table.trim().split(/\r?\n/).filter(r => !r.includes('---'));
    return `<table>${rows.map((r,i) => `<tr>${r.split('|').slice(1,-1).map(c => i===0?`<th>${c}</th>`:`<td>${c}</td>`).join('')}</tr>`).join('')}</table>`;
  });

  // 9. æ¢è¡Œ
  out = out.replace(/\r?\n/g, '<br>');

  // 10. è¿˜åŸä»£ç å—
  out = out.replace(/__CODE(\d+)__/g, (m, i) => `<pre>${codes[i].replace(/```/g,'').replace(/</g, '&lt;')}</pre>`);

  UI.mdContent.innerHTML = out;
}
</script>
</body>
</html>